# update.sh 脚本优化说明

**更新日期**：2024-01-XX  
**目标**：确保 `scripts/update.sh` 在阿里云ECS上能够正确从GitHub拉取代码

---

## 🔧 主要改进

### 1. GitHub仓库地址配置

添加了固定的GitHub仓库地址配置：

```bash
GITHUB_REPO="https://github.com/xinxinzai98/QLM.git"
```

这确保了脚本始终从正确的仓库拉取代码。

---

### 2. Git远程仓库自动检查和配置

新增 `check_git_remote()` 函数，自动执行以下检查：

- ✅ **检查远程仓库是否存在**
  - 如果不存在，自动添加 `origin` 远程仓库
  - URL设置为：`https://github.com/xinxinzai98/QLM.git`

- ✅ **验证远程仓库URL是否正确**
  - 如果URL不匹配，自动更新为正确的URL
  - 避免因为URL错误导致的拉取失败

- ✅ **验证远程分支是否存在**
  - 尝试连接远程仓库验证分支是否存在
  - 如果验证失败，会警告但继续执行（网络问题不影响）

---

### 3. 改进的代码拉取逻辑

#### 自动处理未提交的更改

- 检测到未提交的更改时，自动执行 `git stash`
- 避免因为本地更改导致的合并冲突
- 如果stash失败，尝试清理未跟踪的文件

#### 智能分支切换

- 自动检测当前分支
- 如果不在目标分支上，自动切换
- 如果本地分支不存在，从远程创建本地分支
- 提供详细的切换过程信息

#### 重试机制

- 拉取代码失败时，自动重试最多3次
- 每次重试间隔2秒
- 提供清晰的错误提示信息

---

### 4. 错误处理优化

#### 临时禁用错误退出

在非关键操作中使用 `set +e` 和 `set -e`：

```bash
set +e  # 临时禁用错误退出
git stash push -m "..." 2>&1
STASH_RESULT=$?
set -e  # 重新启用错误退出
```

这允许某些操作失败而不导致整个脚本退出。

#### 详细的错误提示

当操作失败时，提供详细的检查清单：

```bash
error "请检查："
error "  1. 网络连接是否正常"
error "  2. GitHub仓库地址是否正确: $GITHUB_REPO"
error "  3. 分支名称是否正确: $BRANCH"
```

---

## 📋 执行流程

优化后的脚本执行流程：

1. **检查必要文件** (`check_files`)
2. **检查Git远程仓库配置** (`check_git_remote`) ⬅️ **新增**
3. **备份数据** (`backup_data`)
4. **拉取最新代码** (`pull_code`) ⬅️ **改进**
   - 自动处理未提交更改
   - 智能分支切换
   - 重试机制
5. **停止容器** (`stop_container`)
6. **重新构建镜像** (`build_image`)
7. **启动容器** (`start_container`)
8. **等待服务启动** (`wait_for_service`)
9. **健康检查** (`check_health`)

---

## ✅ 解决的问题

### 问题1：远程仓库未配置

**之前**：如果服务器上的Git仓库没有配置远程地址，`git pull` 会失败

**现在**：脚本自动检查并配置远程仓库地址

### 问题2：远程仓库URL错误

**之前**：如果远程URL配置错误，无法拉取代码

**现在**：脚本自动验证并更新URL

### 问题3：网络连接不稳定

**之前**：网络波动导致拉取失败，脚本直接退出

**现在**：自动重试最多3次，提高成功率

### 问题4：本地有未提交更改

**之前**：需要手动处理未提交的更改

**现在**：自动暂存本地更改，避免冲突

### 问题5：分支不存在

**之前**：如果本地分支不存在，需要手动创建

**现在**：自动从远程创建本地分支

---

## 🚀 使用方法

在阿里云ECS服务器上执行：

```bash
cd /opt/QLM  # 或你的项目目录
./scripts/update.sh
```

脚本会自动：
1. 检查并配置Git远程仓库
2. 拉取最新代码
3. 重新部署服务

---

## 🔍 环境变量

可以通过环境变量自定义配置：

```bash
# 自定义分支名称（默认：main）
BRANCH=main ./scripts/update.sh

# 自定义备份目录（默认：项目目录/backups）
BACKUP_DIR=/path/to/backups ./scripts/update.sh
```

---

## ⚠️ 注意事项

1. **网络要求**：脚本需要能够访问GitHub
2. **权限要求**：建议使用root用户运行，确保有足够权限
3. **备份重要性**：更新前会自动备份，但建议定期手动备份

---

## 📝 后续优化建议

1. **支持私有仓库**：如果需要访问私有仓库，可以添加SSH密钥配置
2. **支持代理**：如果服务器无法直接访问GitHub，可以添加代理配置
3. **回滚功能**：添加回滚到之前版本的功能
4. **通知功能**：更新完成后发送通知（邮件、钉钉等）

---

**最后更新**：2024-01-XX

